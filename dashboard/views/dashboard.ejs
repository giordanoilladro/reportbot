<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ReportBot - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { --primary: #5865F2; --bg: #0f0f1a; --card: #1a1a2e; --border: rgba(255,255,255,0.1); }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:#0f0f1a; color:#e0e7ff; min-height:100vh; }
    .container { display:flex; }
    .sidebar { width:280px; background:rgba(15,15,26,0.9); border-right:1px solid var(--border); padding:20px; position:fixed; height:100vh; }
    .main { margin-left:280px; padding:40px; width:100%; }
    .card { background:rgba(26,26,46,0.8); border:1px solid var(--border); border-radius:16px; padding:32px; max-width:1000px; margin:0 auto; }
    .btn { padding:12px 24px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; }
    .form-input, .form-select { width:100%; padding:12px; background:rgba(45,45,68,0.8); border:1px solid var(--border); border-radius:12px; color:white; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .role-row { background:rgba(45,45,68,0.6); padding:16px; border-radius:12px; border:2px solid rgba(88,101,242,0.4); margin:12px 0; }
    .notification { position:fixed; bottom:20px; right:20px; padding:16px 24px; border-radius:12px; color:white; z-index:9999; }
    .success { background:#10b981; }
    .error { background:#ef4444; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2 style="color:#5865F2; margin-bottom:20px;">ReportBot</h2>
      <div style="margin-bottom:30px; text-align:center;">
        <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.webp?size=128" style="width:80px; height:80px; border-radius:50%; border:4px solid #5865F2;">
        <p style="margin-top:10px; font-weight:600;"><%= user.username %></p>
        <a href="/logout" style="color:#ef4444; font-size:0.9rem;">Logout</a>
      </div>
      <div style="margin-bottom:20px;">
        <strong>I tuoi server:</strong>
      </div>
      <% guilds.forEach(g => { %>
        <a href="/guild/<%= g.id %>" style="display:block; padding:10px; background:<%= selectedGuild?.id === g.id ? 'rgba(88,101,242,0.3)' : 'transparent' %>; border-radius:8px; margin:5px 0; color:white; text-decoration:none;">
          <% if(g.icon) { %>
            <img src="https://cdn.discordapp.com/icons/<%= g.id %>/<%= g.icon %>.webp?size=32" style="width:32px; height:32px; border-radius:50%; vertical-align:middle; margin-right:10px;">
          <% } %>
          <%= g.name %>
        </a>
      <% }) %>
    </div>

    <div class="main">
      <% if (!selectedGuild) { %>
        <div class="card">
          <h1 style="font-size:2rem; color:#5865F2;">Benvenuto nella Dashboard</h1>
          <p style="margin-top:20px; font-size:1.1rem;">Seleziona un server a sinistra per configurare ReportBot.</p>
        </div>
      <% } else { %>
        <div class="card">
          <h1 style="color:#5865F2; margin-bottom:10px;"><%= selectedGuild.name %></h1>
          <p>ID: <%= selectedGuild.id %></p>

          <form id="configForm">
            <input type="hidden" name="guildId" value="<%= selectedGuild.id %>">
            <input type="hidden" name="reactionroles.messageId" value="<%= settings.reactionroles?.messageId || '' %>">

            <h2 style="margin:30px 0 20px; color:#5865F2;">Reaction Roles</h2>

            <div class="grid">
              <div>
                <label>Canale</label>
                <select name="reactionroles.channelId" class="form-select">
                  <option value="">Seleziona canale</option>
                  <% selectedGuild.channels.cache.filter(c => c.type === 0).sort((a,b) => a.position - b.position).forEach(ch => { %>
                    <option value="<%= ch.id %>" <%= settings.reactionroles?.channelId === ch.id ? 'selected' : '' %>>#<%= ch.name %></option>
                  <% }) %>
                </select>
              </div>
              <div>
                <label>Titolo</label>
                <input type="text" name="reactionroles.title" class="form-input" value="<%= settings.reactionroles?.title || 'Scegli i tuoi ruoli!' %>">
              </div>
            </div>

            <div id="roles-container" style="margin:20px 0;">
              <% (settings.reactionroles?.roles || []).forEach((r, i) => { %>
                <div class="role-row">
                  <div class="grid">
                    <select name="reactionroles.roles[<%= i %>].roleId" class="forml-select">
                      <option value="">Seleziona ruolo</option>
                      <% selectedGuild.roles.cache.sort((a,b) => b.position - a.position).forEach(role => { %>
                        <option value="<%= role.id %>" <%= r.roleId === role.id ? 'selected' : '' %>><%= role.name %></option>
                      <% }) %>
                    </select>
                    <input type="text" name="reactionroles.roles[<%= i %>].label" class="form-input" value="<%= r.label || '' %>" placeholder="Testo pulsante">
                  </div>
                  <button type="button" onclick="this.parentElement.remove()" style="margin-top:10px; background:#ef4444; color:white; border:none; padding:8px 16px; border-radius:8px;">Rimuovi</button>
                </div>
              <% }) %>
            </div>

            <button type="button" onclick="addRole()" class="btn" style="background:#10b981; margin-right:10px;">+ Aggiungi Ruolo</button>
            <button type="button" onclick="sendMessage()" class="btn">Invia / Aggiorna Messaggio</button>
            <button type="submit" class="btn" style="margin-left:10px; background:#5865F2;">Salva Config</button>
          </form>
        </div>
      <% } %>
    </div>
  </div>

  <script>
    // SOLO SE selectedGuild ESISTE
    const guildId = "<%= selectedGuild ? selectedGuild.id : '' %>";

    function addRole() {
      if (!guildId) return alert("Seleziona un server!");
      const container = document.getElementById('roles-container');
      const index = container.children.length;
      const div = document.createElement('div');
      div.className = 'role-row';
      div.innerHTML = `
        <div class="grid">
          <select name="reactionroles.roles[${index}].roleId" class="form-select">
            <option value="">Seleziona ruolo</option>
            ${Array.from(selectedGuild.roles.cache.sort((a,b) => b.position - a.position).values())
              .map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
          </select>
          <input type="text" name="reactionroles.roles[${index}].label" class="form-input" placeholder="Testo pulsante">
        </div>
        <button type="button" onclick="this.parentElement.remove()" style="margin-top:10px; background:#ef4444; color:white; border:none; padding:8px 16px; border-radius:8px;">Rimuovi</button>
      `;
      container.appendChild(div);
    }

    async function sendMessage() {
      if (!guildId) return showNotif("Seleziona un server!", true);
      
      const form = document.getElementById('configForm');
      const data = new FormData(form);
      const
      const roles = [];
      document.querySelectorAll('.role-row').forEach(row => {
        const roleId = row.querySelector('select')?.value;
        if (roleId) {
          roles.push({
            roleId,
            label: row.querySelector('input')?.value || null
          });
        }
      });
      data.append('roles', JSON.stringify(roles));

      try {
        const res = await fetch(`/guild/${guildId}/reactionrole/send`, {
          method: 'POST',
          body: data
        });
        const json = await res.json();
        if (json.success) {
          document.querySelector('[name="reactionroles.messageId"]').value = json.messageId;
          showNotif("Messaggio inviato/aggiornato!", false);
        } else {
          showNotif(json.error || "Errore", true);
        }
      } catch (err) {
        showNotif("Errore di rete!", true);
      }
    }

    function showNotif(msg, error = false) {
      const n = document.createElement('div');
      n.className = `notification ${error ? 'error' : 'success'}`;
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(() => n.classList.add('show'), 100);
      setTimeout(() => n.remove(), 3000);
    }
  </script>
</body>
</html>
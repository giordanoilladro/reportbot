<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ReportBot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #5865F2; --success: #10b981; --danger: #ef4444;
      --dark: #1a1a2e; --gray: #2d2d44; --border: rgba(255,255,255,0.1);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background:linear-gradient(135deg,#0f0f1a 0%,#1a1a2e 100%);
      color:#e0e7ff; min-height:100vh;
    }
    .sidebar {
      position:fixed; left:0; top:0; width:280px; height:100vh;
      background:rgba(15,15,26,0.9); border-right:1px solid var(--border);
      padding:24px; display:flex; flex-direction:column;
    }
    .main-content { margin-left:280px; padding:40px; }
    .card {
      background:rgba(26,26,46,0.8); border:1px solid var(--border);
      border-radius:16px; padding:32px; max-width:1000px; margin:0 auto;
    }
    .btn {
      padding:12px 24px; background:var(--primary); color:white;
      border:none; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .form-input, .form-select, .form-textarea {
      width:100%; padding:12px; background:rgba(45,45,68,0.8);
      border:1px solid var(--border); border-radius:12px; color:white;
    }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .role-row {
      background:rgba(45,45,68,0.6); padding:16px; border-radius:12px;
      border:2px solid rgba(88,101,242,0.4); margin:12px 0;
    }
    .notification {
      position:fixed; bottom:20px; right:20px; padding:16px 32px;
      border-radius:16px; color:white; font-weight:600; z-index:9999;
    }
    .success { background:#10b981; }
    .error { background:#ef4444; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2 style="color:#5865F2; margin-bottom:20px;">ReportBot</h2>
    <div style="text-align:center; margin-bottom:30px;">
      <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.webp?size=128"
           style="width:80px; height:80px; border-radius:50%; border:4px solid #5865F2;">
      <p style="margin-top:10px; font-weight:600;"><%= user.username %></p>
      <a href="/logout" style="color:#ef4444;">Logout</a>
    </div>
    <strong>I tuoi server:</strong>
    <% guilds.forEach(g => { %>
      <a href="/guild/<%= g.id %>"
         style="display:block; padding:12px; background:<%= selectedGuild?.id === g.id ? 'rgba(88,101,242,0.3)' : 'transparent' %>;
                border-radius:12px; margin:8px 0; color:white; text-decoration:none;">
        <% if(g.icon) { %>
          <img src="https://cdn.discordapp.com/icons/<%= g.id %>/<%= g.icon %>.webp?size=32"
               style="width:32px; height:32px; border-radius:50%; vertical-align:middle; margin-right:10px;">
        <% } %>
        <%= g.name %>
      </a>
    <% }) %>
    <div style="margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
      <a href="/home" style="color:#5865F2; display:block; margin:8px 0;">Home</a>
      <a href="/termini" style="color:#5865F2; display:block; margin:8px 0;">Termini</a>
      <a href="/privacy" style="color:#5865F2; display:block; margin:8px 0;">Privacy</a>
      <a href="/collabora" style="color:#5865F2; display:block; margin:8px 0;">Collabora</a>
    </div>
  </div>

  <div class="main-content">
    <% if (!selectedGuild) { %>
      <div class="card">
        <h1 style="color:#5865F2; font-size:2rem;">Benvenuto!</h1>
        <p>Seleziona un server a sinistra per configurare ReportBot.</p>
      </div>
    <% } else { %>
      <div class="card">
        <h1 style="color:#5865F2;"><%= selectedGuild.name %></h1>
        <p>ID: <%= selectedGuild.id %></p>

        <form id="configForm">
          <input type="hidden" name="guildId" value="<%= selectedGuild.id %>">
          <input type="hidden" name="reactionroles.messageId" value="<%= settings.reactionroles?.messageId || '' %>">

          <!-- TAB BUTTONS -->
          <div style="margin:30px 0; border-bottom:2px solid rgba(88,101,242,0.3); display:flex; gap:20px;">
            <button type="button" onclick="showTab('general')" class="tab-btn active">Generale</button>
            <button type="button" onclick="showTab('verify')" class="tab-btn">Verifica</button>
            <button type="button" onclick="showTab('report')" class="tab-btn">Report</button>
            <button type="button" onclick="showTab('reactionroles')" class="tab-btn">Reaction Roles</button>
          </div>

          <!-- GENERALE -->
          <div id="general" class="tab">
            <div class="grid">
              <div>
                <label>Canale Log</label>
                <input name="logChannelId" class="form-input" value="<%= settings.logChannelId || '' %>">
              </div>
              <div>
                <label>Ruolo Mute</label>
                <input name="setup.muteRoleId" class="form-input" value="<%= settings.setup?.muteRoleId || '' %>">
              </div>
            </div>
          </div>

          <!-- VERIFICA -->
          <div id="verify" class="tab" style="display:none">
            <label><input type="checkbox" name="verify.enabled" <%= settings.verify?.enabled ? 'checked' : '' %>> Abilita verifica</label>
          </div>

          <!-- REPORT -->
          <div id="report" class="tab" style="display:none">
            <div>
              <label>Canale Report</label>
              <input name="report.channelId" class="form-input" value="<%= settings.report?.channelId || '' %>">
            </div>
            <label><input type="checkbox" name="report.requireReason" <%= settings.report?.requireReason ? 'checked' : '' %>> Richiedi motivo</label>
          </div>

          <!-- REACTION ROLES -->
          <div id="reactionroles" class="tab" style="display:none">
            <label><input type="checkbox" name="reactionroles.enabled" <%= settings.reactionroles?.enabled ? 'checked' : '' %>> Abilita Reaction Roles</label>

            <div class="grid" style="margin-top:20px;">
              <div>
                <label>Canale</label>
                <select name="reactionroles.channelId" class="form-select">
                  <option value="">Seleziona canale...</option>
                  <% 
                  // USA I CANALI PASSATI DAL BACKEND, NON selectedGuild.channels!
                  (channels || []).forEach(ch => { %>
                    <option value="<%= ch.id %>" <%= settings.reactionroles?.channelId === ch.id ? 'selected' : '' %>>
                      #<%= ch.name %>
                    </option>
                  <% }) %>
                </select>
              </div>
              <div>
                <label>Colore (HEX)</label>
                <input name="reactionroles.color" class="form-input" value="<%= settings.reactionroles?.color || '#5865F2' %>">
              </div>
            </div>

            <div style="margin-top:20px;">
              <label>Titolo</label>
              <input name="reactionroles.title" class="form-input" value="<%= settings.reactionroles?.title || 'Scegli i tuoi ruoli!' %>">
            </div>

            <div style="margin-top:20px;">
              <label>Descrizione</label>
              <textarea name="reactionroles.description" class="form-textarea"><%= settings.reactionroles?.description || '' %></textarea>
            </div>

            <div id="roles-container" style="margin:20px 0;">
              <% (settings.reactionroles?.roles || []).forEach((r, i) => { %>
                <div class="role-row">
                  <div class="grid">
                    <select name="reactionroles.roles[<%= i %>].roleId" class="form-select">
                      <option value="">Seleziona ruolo...</option>
                      <% (roles || []).forEach(role => { %>
                        <option value="<%= role.id %>" <%= r.roleId === role.id ? 'selected' : '' %>><%= role.name %></option>
                      <% }) %>
                    </select>
                    <input name="reactionroles.roles[<%= i %>].label" class="form-input" value="<%= r.label || '' %>" placeholder="Testo pulsante">
                  </div>
                  <button type="button" onclick="this.parentElement.remove()" style="margin-top:10px; background:#ef4444; color:white; border:none; padding:8px; border-radius:8px;">Rimuovi</button>
                </div>
              <% }) %>
            </div>

            <button type="button" onclick="addRole()" style="background:#10b981;" class="btn">+ Aggiungi Ruolo</button>
            <button type="button" onclick="sendMessage()" class="btn">Invia Messaggio</button>
          </div>

          <div style="margin-top:30px;">
            <button type="submit" class="btn">Salva Configurazione</button>
          </div>
        </form>
      </div>
    <% } %>
  </div>

  <script>
    const guildId = "<%= selectedGuild?.id || '' %>";

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tab).style.display = 'block';
      event.target.classList.add('active');
    }

    function addRole() {
      if (!guildId) return alert("Seleziona un server!");
      const container = document.getElementById('roles-container');
      const index = container.children.length;
      const div = document.createElement('div');
      div.className = 'role-row';
      div.innerHTML = `
        <div class="grid">
          <select name="reactionroles.roles[${index}].roleId" class="form-select">
            <option value="">Seleziona ruolo...</option>
            ${((window.roles || []).map(r => `<option value="${r.id}">${r.name}</option>`)).join('')}
          </select>
          <input name="reactionroles.roles[${index}].label" class="form-input" placeholder="Testo pulsante">
        </div>
        <button type="button" onclick="this.parentElement.remove()" style="margin-top:10px; background:#ef4444; color:white; border:none; padding:8px; border-radius:8px;">Rimuovi</button>
      `;
      container.appendChild(div);
    }

    async function sendMessage() {
      if (!guildId) return showNotif("Seleziona un server!", true);
      
      const form = document.getElementById('configForm');
      const data = new FormData(form);
      const roles = [];
      document.querySelectorAll('.role-row').forEach(row => {
        const roleId = row.querySelector('select')?.value;
        const label = row.querySelector('input')?.value;
        if (roleId) roles.push({ roleId, label: label || null });
      });
      data.append('roles', JSON.stringify(roles));

      try {
        const res = await fetch(`/guild/${guildId}/reactionrole/send`, { method: 'POST', body: data });
        const json = await res.json();
        if (json.success) {
          document.querySelector('[name="reactionroles.messageId"]').value = json.messageId;
          showNotif("Messaggio inviato!", false);
        } else {
          showNotif(json.error || "Errore", true);
        }
      } catch (e) {
        showNotif("Errore di rete!", true);
      }
    }

    function showNotif(msg, error = false) {
      const n = document.createElement('div');
      n.className = `notification ${error ? 'error' : 'success'}`;
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 3000);
    }

    // Inizializza
    document.querySelector('.tab-btn').classList.add('active');
  </script>

  <!-- PASSA CANALI E RUOLI DAL BACKEND -->
  <script>
    window.channels = <%- JSON.stringify(channels || []) %>;
    window.roles = <%- JSON.stringify(roles || []) %>;
  </script>
</body>
</html>
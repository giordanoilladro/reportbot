<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HamsterBot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" />
  <style>
    :root {
      --bg1: #09090f;
      --bg2: #141420;
      --accent1: #8b0000;
      --accent2: #d32f2f;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --glass: rgba(255, 255, 255, 0.06);
      --glass-hover: rgba(255, 255, 255, 0.1);
      --border: rgba(255, 255, 255, 0.08);
      --radius: 18px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg1);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    canvas#bgAnimation { position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1; }

    /* HEADER */
    header {
      position: sticky; top:0; z-index:100;
      display: flex; align-items:center; gap:20px;
      padding: 18px 32px;
      background: rgba(20,20,32,0.7);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .logo { width:60px; height:60px; border-radius:50%; overflow:hidden; box-shadow:0 0 20px rgba(211,47,47,0.4); }
    .logo img { width:100%; height:100%; object-fit:cover; }
    .header-title h1 { font-family:'Poppins',sans-serif; font-size:1.4rem; color:var(--accent2); margin:0; }
    .header-title p { color:var(--muted); font-size:0.9rem; margin:0; }
    .header-right { margin-left:auto; display:flex; gap:12px; align-items:center; }
    .nav-btn {
      padding:8px 16px; border-radius:999px; background:var(--glass); border:1px solid var(--border);
      color:var(--text); text-decoration:none; font-size:0.9rem; transition:all .3s;
      display:inline-flex; align-items:center; gap:6px;
    }
    .nav-btn:hover { background:var(--glass-hover); transform:translateY(-2px); }
    .discord-btn { background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; font-weight:600; }

    /* LAYOUT */
    .dashboard {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: calc(100vh - 96px);
    }
    .sidebar {
      background: rgba(20,20,32,0.6); backdrop-filter:blur(12px);
      border-right:1px solid var(--border); padding:24px 16px;
      overflow-y:auto;
    }
    .user-info {
      display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px;
      background:var(--glass); margin-bottom:24px;
    }
    .avatar { width:48px; height:48px; border-radius:50%; border:2px solid var(--accent2); }
    .username { font-weight:600; }
    .logout { color:#ef4444; font-size:0.85rem; text-decoration:none; }

    .server-list a {
      display:flex; align-items:center; gap:12px; padding:10px 14px;
      border-radius:12px; color:var(--muted); text-decoration:none;
      margin:4px 0; transition:all .3s;
    }
    .server-list a:hover, .server-list a.active {
      background:rgba(211,47,47,0.15); color:white; transform:translateX(6px);
    }
    .server-list a.active { border-left:4px solid var(--accent2); }
    .server-icon {
      width:38px; height:38px; border-radius:50%; background:var(--bg2);
      display:flex; align-items:center; justify-content:center; font-weight:700; color:white;
    }

    .main-content { padding:32px; }
    .card {
      background: var(--glass); backdrop-filter:blur(16px);
      border:1px solid var(--border); border-radius:var(--radius);
      padding:32px; max-width:1000px; margin:0 auto;
      box-shadow:0 15px 40px rgba(0,0,0,0.6);
    }
    .guild-header {
      display:flex; align-items:center; gap:20px; margin-bottom:32px;
      padding-bottom:20px; border-bottom:1px solid var(--border);
    }
    .guild-icon-large {
      width:80px; height:80px; border-radius:50%; border:4px solid var(--accent2);
      box-shadow:0 0 25px rgba(211,47,47,0.5);
    }

    /* TABS */
    .tabs {
      display:flex; gap:10px; margin-bottom:30px; border-bottom:1px solid var(--border);
    }
    .tab-btn {
      padding:12px 24px; background:transparent; border:none; color:var(--muted);
      font-weight:500; border-radius:12px 12px 0 0; cursor:pointer; transition:all .3s;
    }
    .tab-btn:hover, .tab-btn.active { color:white; background:rgba(211,47,47,0.2); }
    .tab-btn.active { border-bottom:3px solid var(--accent2); }

    /* FORM */
    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; font-weight:500; color:var(--text); }
    .form-input, .form-select, .form-textarea {
      width:100%; padding:12px 16px; background:rgba(255,255,255,0.08);
      border:1px solid var(--border); border-radius:12px; color:white;
      transition:all .3s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline:none; border-color:var(--accent2); box-shadow:0 0 0 3px rgba(211,47,47,0.2);
    }
    .form-textarea { min-height:110px; resize:vertical; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media (max-width:768px) { .grid-2 { grid-template-columns:1fr; } }

    .btn {
      padding:12px 28px; border:none; border-radius:12px; font-weight:600;
      cursor:pointer; transition:all .3s; display:inline-flex; align-items:center; gap:8px;
    }
    .btn-primary {
      background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white;
      box-shadow:0 6px 20px rgba(211,47,47,0.4);
    }
    .btn-primary:hover { transform:translateY(-3px); box-shadow:0 10px 30px rgba(211,47,47,0.6); }

    .role-row {
      background:rgba(255,255,255,0.05); padding:20px; border-radius:12px;
      border:1px solid rgba(211,47,47,0.3); margin:16px 0;
    }

    .notification {
      position:fixed; bottom:24px; right:24px; padding:16px 32px;
      border-radius:16px; color:white; min-width:320px;
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
      transform:translateY(100px); opacity:0; transition:all .4s;
      display:flex; align-items:center; gap:12px;
    }
    .notification.show { transform:translateY(0); opacity:1; }
    .notification.success { background:linear-gradient(135deg,#10b981,#059669); }
    .notification.error { background:linear-gradient(135deg,#ef4444,#dc2626); }

    .load-rr-card {
      background: rgba(211, 47, 47, 0.1);
      border: 2px solid rgba(211, 47, 47, 0.4);
      border-radius: 18px;
      padding: 28px;
      margin-top: 32px;
      backdrop-filter: blur(12px);
    }
    .load-rr-card h3 { color:#ff6b6b; margin-bottom:16px; }
  </style>
</head>
<body>

<canvas id="bgAnimation"></canvas>

<header>
  <a href="/home" class="logo">
    <img src="https://i.imgur.com/E3vqnQz.jpeg" alt="Hamster">
  </a>
  <div class="header-title">
    <h1>HamsterBot Dashboard</h1>
    <p>Gestisci il tuo server con stile</p>
  </div>
  <div class="header-right">
    <a href="/home" class="nav-btn">Home</a>
    <a href="/termini" class="nav-btn">Termini</a>
    <a href="/privacy" class="nav-btn">Privacy</a>
    <a href="/collabora" class="nav-btn">Collabora</a>
    <a href="https://discord.gg/aFHaVbTFUY" target="_blank" class="nav-btn discord-btn">
      Discord
    </a>
    <a href="/logout" class="nav-btn" style="color:#ef4444;">Logout</a>
  </div>
</header>

<div class="dashboard">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="user-info">
      <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.webp?size=64" class="avatar" alt="Avatar">
      <div>
        <div class="username"><%= user.username %></div>
      </div>
    </div>

    <div class="server-list">
      <% guilds.forEach(g => { %>
        <a href="/guild/<%= g.id %>" class="<%= selectedGuild && selectedGuild.id === g.id ? 'active' : '' %>">
          <% if (g.icon) { %>
            <img src="https://cdn.discordapp.com/icons/<%= g.id %>/<%= g.icon %>.webp?size=40" class="server-icon">
          <% } else { %>
            <div class="server-icon"><%= g.name.charAt(0) %></div>
          <% } %>
          <span><%= g.name %></span>
        </a>
      <% }) %>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <% if (!selectedGuild) { %>
      <div class="card" data-aos="fade-up">
        <h2>Bentornato, <%= user.username %>!</h2>
        <p>Seleziona un server dalla sidebar per gestire le impostazioni di HamsterBot.</p>
      </div>
    <% } else { %>
      <div class="card" data-aos="fade-up">
        <div class="guild-header">
          <% if (selectedGuild.icon) { %>
            <img src="https://cdn.discordapp.com/icons/<%= selectedGuild.id %>/<%= selectedGuild.icon %>.webp?size=80" class="guild-icon-large">
          <% } else { %>
            <div class="guild-icon-large" style="background:var(--accent2);display:flex;align-items:center;justify-content:center;color:white;font-size:2.5rem;font-weight:700;">
              <%= selectedGuild.name.charAt(0) %>
            </div>
          <% } %>
          <div>
            <h2><%= selectedGuild.name %></h2>
            <p style="color:var(--muted);">ID: <%= selectedGuild.id %></p>
          </div>
        </div>

        <form id="configForm" method="POST" action="/guild/<%= selectedGuild.id %>/save">
          <input type="hidden" name="guildId" value="<%= selectedGuild.id %>">
          <input type="hidden" name="reactionroles.messageId" value="<%= settings.reactionroles?.messageId || '' %>">

          <div class="tabs">
            <button type="button" class="tab-btn active" data-tab="general">Generale</button>
            <button type="button" class="tab-btn" data-tab="verify">Verifica</button>
            <button type="button" class="tab-btn" data-tab="report">Report</button>
            <button type="button" class="tab-btn" data-tab="reactionroles">Reaction Roles</button>
          </div>

          <!-- TAB GENERALE -->
          <div id="general" class="tab-content">
            <div class="grid-2">
              <div class="form-group">
                <label>Canale Log</label>
                <input type="text" name="logChannelId" class="form-input" value="<%= settings.logChannelId || '' %>" placeholder="123456789012345678">
              </div>
              <div class="form-group">
                <label>Ruolo Mute</label>
                <input type="text" name="setup.muteRoleId" class="form-input" value="<%= settings.setup?.muteRoleId || '' %>" placeholder="987654321098765432">
              </div>
            </div>
          </div>

          <!-- TAB VERIFICA -->
          <div id="verify" class="tab-content" style="display:none">
            <div class="form-group">
              <label>
                <input type="checkbox" name="verify.enabled" <%= settings.verify?.enabled ? 'checked' : '' %>> 
                Abilita sistema di verifica
              </label>
            </div>
          </div>

          <!-- TAB REPORT -->
          <div id="report" class="tab-content" style="display:none">
            <div class="form-group">
              <label>Canale Report</label>
              <input type="text" name="report.channelId" class="form-input" value="<%= settings.report?.channelId || '' %>">
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" name="report.requireReason" <%= settings.report?.requireReason ? 'checked' : '' %>>
                Richiedi motivo nel report
              </label>
            </div>
          </div>

          <!-- TAB REACTION ROLES -->
          <div id="reactionroles" class="tab-content" style="display:none">
            <div class="form-group">
              <label>
                <input type="checkbox" name="reactionroles.enabled" <%= settings.reactionroles?.enabled ? 'checked' : '' %>>
                Abilita Reaction Roles
              </label>
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label>Canale del messaggio</label>
                <select name="reactionroles.channelId" class="form-select">
                  <option value="">Seleziona canale...</option>
                  <% (channels || []).forEach(ch => { %>
                    <option value="<%= ch.id %>" <%= settings.reactionroles?.channelId === ch.id ? 'selected' : '' %>>#<%= ch.name %></option>
                  <% }) %>
                </select>
              </div>
              <div class="form-group">
                <label>Colore embed (HEX)</label>
                <input type="text" name="reactionroles.color" class="form-input" value="<%= settings.reactionroles?.color || '#d32f2f' %>">
              </div>
            </div>

            <div class="form-group">
              <label>Titolo embed</label>
              <input type="text" name="reactionroles.title" class="form-input" value="<%= settings.reactionroles?.title || 'Scegli i tuoi ruoli!' %>">
            </div>

            <div class="form-group">
              <label>Descrizione</label>
              <textarea name="reactionroles.description" class="form-textarea"><%= settings.reactionroles?.description || 'Clicca sui pulsanti qui sotto per ottenere i ruoli che preferisci!' %></textarea>
            </div>

            <div id="roles-container">
              <% (settings.reactionroles?.roles || []).forEach((r, i) => { %>
                <div class="role-row">
                  <div class="grid-2">
                    <div class="form-group">
                      <select name="reactionroles.roles[<%= i %>].roleId" class="form-select">
                        <option value="">Seleziona ruolo...</option>
                        <% (roles || []).forEach(role => { %>
                          <option value="<%= role.id %>" <%= r.roleId === role.id ? 'selected' : '' %>><%= role.name %></option>
                        <% }) %>
                      </select>
                    </div>
                    <div class="form-group">
                      <input type="text" name="reactionroles.roles[<%= i %>].label" class="form-input" value="<%= r.label || '' %>" placeholder="Testo pulsante">
                    </div>
                  </div>
                  <button type="button" onclick="this.closest('.role-row').remove()" class="btn" style="background:#ef4444;margin-top:12px;width:100%;">Rimuovi</button>
                </div>
              <% }) %>
            </div>

            <button type="button" onclick="addRoleRow()" class="btn btn-primary" style="margin:20px 0;">Aggiungi Ruolo</button>
            <button type="button" onclick="sendReactionRoleMessage()" class="btn btn-primary">Invia / Aggiorna Messaggio</button>

            <% if (settings.reactionroles?.channelId) { %>
              <div class="load-rr-card">
                <h3>Reaction Role già attivo</h3>
                <p><strong><%= settings.reactionroles.title || 'Senza titolo' %></strong><br>
                Canale: <%= settings.reactionroles.channelId ? '<#' + settings.reactionroles.channelId + '>' : 'non impostato' %> • 
                <%= (settings.reactionroles.roles || []).length %> ruoli</p>
                <p style="margin-top:12px;color:var(--muted);font-style:italic;">
                  Modifica i campi sopra e premi "Salva Configurazione" per aggiornare il messaggio esistente.
                </p>
              </div>
            <% } %>

            <div style="margin-top:32px;">
              <button type="submit" class="btn btn-primary" style="padding:16px 40px;font-size:1.1rem;">Salva Configurazione</button>
            </div>
          </div>
        </form>
      </div>
    <% } %>
  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<script>
  AOS.init({ duration: 800, once: 'ease' });

  // PARTICLES BACKGROUND (stesso di collabora.html)
  const canvas = document.getElementById('bgAnimation');
  const ctx = canvas.getContext('2d');
  let particles = [];
  function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  for(let i=0;i<140;i++){
    particles.push({
      x: Math.random()*canvas.width,
      y: Math.random()*canvas.height,
      size: Math.random()*3+1,
      speedX: (Math.random()-0.5)*1.5,
      speedY: (Math.random()-0.5)*1.5
    });
  }
  canvas.addEventListener('mousemove', e => {
    particles.forEach(p => {
      const dx = p.x - e.clientX;
      const dy = p.y - e.clientY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < 120) { p.x += dx*0.03; p.y += dy*0.03; }
    });
  });
  function animate(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.strokeStyle = 'rgba(211,47,47,0.4)';
    particles.forEach(p=>{
      p.x += p.speedX; p.y += p.speedY;
      if(p.x<0 || p.x>canvas.width) p.speedX *= -1;
      if(p.y<0 || p.y>canvas.height) p.speedY *= -1;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
    });
    for(let a=0;a<particles.length;a++){
      for(let b=a+1;b<particles.length;b++){
        const dx=particles[a].x-particles[b].x;
        const dy=particles[a].y-particles[b].y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<130){
          ctx.beginPath();
          ctx.moveTo(particles[a].x,particles[a].y);
          ctx.lineTo(particles[b].x,particles[b].y);
          ctx.stroke();
        }
      }
    }
    requestAnimationFrame(animate);
  }
  animate();

  // TABS + TUTTE LE FUNZIONI ORIGINALI (identiche)
  const guildId = "<%= selectedGuild ? selectedGuild.id : '' %>";
  const hasGuild = !!guildId;

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).style.display = 'block';
    });
  });

  function addRoleRow() {
    if (!hasGuild) return showNotification("Seleziona un server!", true);
    const container = document.getElementById('roles-container');
    const index = container.children.length;
    const div = document.createElement('div');
    div.className = 'role-row';
    div.innerHTML = `
      <div class="grid-2">
        <div class="form-group">
          <select name="reactionroles.roles[${index}].roleId" class="form-select">
            <option value="">Seleziona ruolo...</option>
            ${window.roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <input type="text" name="reactionroles.roles[${index}].label" class="form-input" placeholder="Testo pulsante">
        </div>
      </div>
      <button type="button" onclick="this.closest('.role-row').remove()" class="btn" style="background:#ef4444;margin-top:12px;width:100%">Rimuovi</button>
    `;
    container.appendChild(div);
  }

  async function sendReactionRoleMessage() {
    if (!hasGuild) return showNotification("Seleziona un server!", true);
    const data = new FormData(document.getElementById('configForm'));
    try {
      const res = await fetch(`/guild/${guildId}/reactionrole/send`, {
        method: 'POST', body: data, credentials: 'include'
      });
      const json = await res.json();
      showNotification(json.success ? "Messaggio inviato/aggiornato!" : json.error || "Errore", !json.success);
      if (json.success && json.messageId) {
        document.querySelector('[name="reactionroles.messageId"]').value = json.messageId;
      }
    } catch { showNotification("Errore di rete", true); }
  }

  function showNotification(msg, error = false) {
    const n = document.createElement('div');
    n.className = `notification ${error ? 'error' : 'success'} show`;
    n.innerHTML = `<i class="fas fa-${error ? 'exclamation' : 'check'}-circle"></i> ${msg}`;
    document.body.appendChild(n);
    setTimeout(() => n.classList.remove('show'), 3000);
    setTimeout(() => n.remove(), 4000);
  }

  // SALVATAGGIO (con fix Content-Type)
  document.getElementById('configForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    const old = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'Salvataggio...';

    const data = new FormData(this);
    const urlEncoded = new URLSearchParams(data).toString();

    try {
      const res = await fetch(this.action, {
        method: 'POST',
        body: urlEncoded,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        credentials: 'include'
      });
      const json = await res.json();
      showNotification(json.success ? (json.message || 'Salvato!') : json.error, !json.success);
    } catch {
      showNotification('Errore di connessione', true);
    } finally {
      btn.disabled = false;
      btn.innerHTML = old;
    }
  });

  window.channels = <%- JSON.stringify(channels || []) %>;
  window.roles = <%- JSON.stringify(roles || []) %>;

  if (hasGuild) document.getElementById('general').style.display = 'block';
</script>
</body>
</html>
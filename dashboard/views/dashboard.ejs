<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ReportBot - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { --primary: #5865F2; --bg: #0f0f1a; --card: #1a1a2e; --border: rgba(255,255,255,0.1); --success: #10b981; --danger: #ef4444; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:#0f0f1a; color:#e0e7ff; min-height:100vh; }
    .container { display:flex; }
    .sidebar { width:280px; background:rgba(15,15,26,0.95); border-right:1px solid var(--border); padding:24px; position:fixed; height:100vh; backdrop-filter:blur(10px); }
    .main { margin-left:280px; padding:40px; width:100%; }
    .card { background:rgba(26,26,46,0.9); border:1px solid var(--border); border-radius:16px; padding:32px; max-width:1000px; margin:0 auto; box-shadow:0 20px 40px rgba(0,0,0,0.3); }
    .btn { padding:14px 28px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:700; transition:all 0.3s; }
    .btn:hover { background:#7c89f5; transform:translateY(-2px); }
    .btn-success { background:var(--success); }
    .btn-danger { background:var(--danger); }
    .form-input, .form-select, .form-textarea { width:100%; padding:14px; background:rgba(45,45,68,0.9); border:1px solid var(--border); border-radius:12px; color:white; font-size:1rem; }
    .form-input:focus, .form-select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(88,101,242,0.3); }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .role-row { background:rgba(45,45,68,0.7); padding:20px; border-radius:14px; border:2px solid rgba(88,101,242,0.5); margin:16px 0; position:relative; }
    .remove-btn { position:absolute; top:10px; right:10px; background:var(--danger); color:white; border:none; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1.2rem; }
    .notification { position:fixed; bottom:30px; right:30px; padding:18px 32px; border-radius:16px; color:white; font-weight:600; box-shadow:0 10px 30px rgba(0,0,0,0.4); z-index:9999; transform:translateY(100px); opacity:0; transition:all 0.4s; }
    .notification.show { transform:translateY(0); opacity:1; }
    .success { background:linear-gradient(135deg,#10b981,#059669); }
    .error { background:linear-gradient(135deg,#ef4444,#dc2626); }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2 style="color:#5865F2; font-size:1.8rem; margin-bottom:24px; text-align:center;">ReportBot</h2>
      <div style="text-align:center; margin-bottom:32px;">
        <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.webp?size=128" style="width:90px; height:90px; border-radius:50%; border:5px solid #5865F2; box-shadow:0 0 20px rgba(88,101,242,0.5);">
        <p style="margin-top:12px; font-weight:700; font-size:1.1rem;"><%= user.username %></p>
        <a href="/logout" style="color:#ef4444; font-size:0.9rem; text-decoration:none;">Logout</a>
      </div>
      <strong style="color:#9ca3af; font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">I tuoi server</strong>
      <div style="margin-top:12px;">
        <% guilds.forEach(g => { %>
          <a href="/guild/<%= g.id %>" style="display:flex; align-items:center; gap:12px; padding:12px; background:<%= selectedGuild?.id === g.id ? 'rgba(88,101,242,0.3)' : 'transparent' %>; border-radius:12px; margin:8px 0; color:white; text-decoration:none; font-weight:500; transition:all 0.3s;">
            <% if(g.icon) { %>
              <img src="https://cdn.discordapp.com/icons/<%= g.id %>/<%= g.icon %>.webp?size=64" style="width:40px; height:40px; border-radius:50%;">
            <% } else { %>
              <div style="width:40px; height:40px; background:#5865F2; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;"><%= g.name[0] %></div>
            <% } %>
            <span><%= g.name %></span>
          </a>
        <% }) %>
      </div>
    </div>

    <div class="main">
      <% if (!selectedGuild) { %>
        <div class="card">
          <h1 style="font-size:2.5rem; color:#5865F2; text-align:center;">Benvenuto su ReportBot</h1>
          <p style="margin-top:24px; font-size:1.2rem; text-align:center; color:#b0b7d0;">Seleziona un server dalla barra laterale per iniziare la configurazione.</p>
        </div>
      <% } else { %>
        <div class="card">
          <h1 style="color:#5865F2; font-size:2rem; margin-bottom:8px;"><%= selectedGuild.name %></h1>
          <p style="color:#9ca3af; margin-bottom:32px;">ID: <%= selectedGuild.id %></p>

          <form id="configForm">
            <input type="hidden" name="guildId" value="<%= selectedGuild.id %>">
            <input type="hidden" name="reactionroles.messageId" value="<%= settings.reactionroles?.messageId || '' %>">

            <h2 style="color:#5865F2; font-size:1.6rem; margin:32px 0 24px;">Reaction Roles</h2>

            <div class="grid">
              <div>
                <label style="display:block; margin-bottom:8px; font-weight:600;">Canale del messaggio</label>
                <select name="reactionroles.channelId" class="form-select">
                  <option value="">Seleziona un canale...</option>
                  <% selectedGuild.channels.cache
                    .filter(c => c.type === 0)
                    .sort((a,b) => a.position - b.position)
                    .forEach(ch => { %>
                    <option value="<%= ch.id %>" <%= settings.reactionroles?.channelId === ch.id ? 'selected' : '' %>>
                      #<%= ch.name %>
                    </option>
                  <% }) %>
                </select>
              </div>
              <div>
                <label style="display:block; margin-bottom:8px; font-weight:600;">Titolo embed</label>
                <input type="text" name="reactionroles.title" class="form-input" value="<%= settings.reactionroles?.title || 'Scegli i tuoi ruoli!' %>">
              </div>
            </div>

            <div style="margin:24px 0;">
              <label style="display:block; margin-bottom:8px; font-weight:600;">Descrizione</label>
              <textarea name="reactionroles.description" class="form-textarea" rows="3"><%= settings.reactionroles?.description || 'Clicca sui pulsanti qui sotto per ottenere i ruoli!' %></textarea>
            </div>

            <div id="roles-container">
              <% (settings.reactionroles?.roles || []).forEach((r, i) => { %>
                <div class="role-row">
                  <button type="button" class="remove-btn" onclick="this.parentElement.remove()">X</button>
                  <div class="grid">
                    <div>
                      <label>Ruolo</label>
                      <select name="reactionroles.roles[<%= i %>].roleId" class="form-select">
                        <option value="">Seleziona ruolo...</option>
                        <% selectedGuild.roles.cache
                          .sort((a,b) => b.position - a.position)
                          .forEach(role => { %>
                          <option value="<%= role.id %>" <%= r.roleId === role.id ? 'selected' : '' %>><%= role.name %></option>
                        <% }) %>
                      </select>
                    </div>
                    <div>
                      <label>Testo pulsante</label>
                      <input type="text" name="reactionroles.roles[<%= i %>].label" class="form-input" value="<%= r.label || '' %>" placeholder="es. Gamer">
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>

            <div style="margin:32px 0;">
              <button type="button" onclick="addRole()" class="btn btn-success" style="margin-right:12px;">
                + Aggiungi Ruolo
              </button>
              <button type="button" onclick="sendMessage()" class="btn" style="background:#5865F2;">
                Invia / Aggiorna Messaggio
              </button>
              <button type="submit" class="btn" style="margin-left:12px; background:#10b981;">
                Salva Configurazione
              </button>
            </div>
          </form>
        </div>
      <% } %>
    </div>
  </div>

  <script>
    const guildId = "<%= selectedGuild ? selectedGuild.id : '' %>";

    function addRole() {
      if (!guildId) return showNotif("Seleziona un server prima!", true);
      const container = document.getElementById('roles-container');
      const index = container.children.length;
      const div = document.createElement('div');
      div.className = 'role-row';
      div.innerHTML = `
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">X</button>
        <div class="grid">
          <div>
            <label>Ruolo</label>
            <select name="reactionroles.roles[${index}].roleId" class="form-select">
              <option value="">Seleziona ruolo...</option>
              ${Array.from(selectedGuild.roles.cache.sort((a,b) => b.position - a.position).values())
                .map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
            </select>
          </div>
          <div>
            <label>Testo pulsante</label>
            <input type="text" name="reactionroles.roles[${index}].label" class="form-input" placeholder="es. Member">
          </div>
        </div>
      `;
      container.appendChild(div);
    }

    async function sendMessage() {
      if (!guildId) return showNotif("Seleziona un server!", true);

      const form = document.getElementById('configForm');
      const data = new FormData(form);
      const roles = [];
      
      document.querySelectorAll('.role-row').forEach(row => {
        const roleId = row.querySelector('select')?.value;
        const label = row.querySelector('input')?.value;
        if (roleId) {
          roles.push({ roleId, label: label || null });
        }
      });

      data.append('roles', JSON.stringify(roles));

      try {
        const res = await fetch(`/guild/${guildId}/reactionrole/send`, {
          method: 'POST',
          body: data
        });
        const json = await res.json();
        
        if (json.success) {
          document.querySelector('[name="reactionroles.messageId"]').value = json.messageId;
          showNotif("Messaggio Reaction Role inviato con successo!", false);
        } else {
          showNotif(json.error || "Errore sconosciuto", true);
        }
      } catch (err) {
        showNotif("Errore di connessione!", true);
      }
    }

    function showNotif(msg, error = false) {
      // Rimuovi notifiche precedenti
      document.querySelectorAll('.notification').forEach(n => n.remove());
      
      const n = document.createElement('div');
      n.className = `notification ${error ? 'error' : 'success'} show`;
      n.innerHTML = `${error ? 'Errore' : 'Fatto'} ${msg}`;
      document.body.appendChild(n);
      
      setTimeout(() => {
        n.classList.remove('show');
        setTimeout(() => n.remove(), 500);
      }, 3000);
    }
  </script>
</body>
</html>